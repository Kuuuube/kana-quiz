var kana = {
	'hentaigana-a': {'𛀂𛀅𛀃𛀄':'a'},
	'hentaigana-i': {'𛀆𛀇𛀈𛀉':'i'},
	'hentaigana-u': {'𛀊𛀋𛀌𛀍𛀎':'u'},
	'hentaigana-e': {'𛀁𛀏𛀐𛀑𛀒𛀓':'e'},
	'hentaigana-o': {'𛀔𛀕𛀖':'o'},
	'hentaigana-ka': {'𛀗𛀘𛀙𛀚𛀛𛀢𛀜𛀝𛀞𛀟𛀠𛀡':'ka'},
	'hentaigana-ki': {'𛀣𛀤𛀥𛀦𛀻𛀧𛀨𛀩𛀪':'ki'},
	'hentaigana-ku': {'𛀫𛀬𛀭𛀮𛀯𛀰𛀱':'ku'},
	'hentaigana-ke': {'𛀳𛀲𛀢𛀴𛀵𛀶𛀷':'ke'},
	'hentaigana-ko': {'𛀸𛂘𛀹𛀻𛀺':'ko'},
	'hentaigana-sa': {'𛀼𛀽𛀾𛀿𛁀𛁁𛁂𛁃':'sa'},
	'hentaigana-si': {'𛁄𛁅𛁆𛁇𛁈𛁉':'shi'},
	'hentaigana-su': {'𛁊𛁋𛁌𛁍𛁎𛁏𛁐𛁑':'su'},
	'hentaigana-se': {'𛁒𛁓𛁔𛁕𛁖':'se'},
	'hentaigana-so': {'𛁗𛁘𛁙𛁚𛁛𛁜𛁝':'so'},
	'hentaigana-ta': {'𛁞𛁟𛁠𛁡':'ta'},
	'hentaigana-ti': {'𛁢𛁣𛁤𛁥𛁦𛁧𛁨':'chi'},
	'hentaigana-tu': {'𛁩𛁪𛁫𛁬𛁭':'tsu'},
	'hentaigana-te': {'𛁮𛁯𛁰𛁱𛁲𛁳𛁴𛁵𛁶𛂎':'te'},
	'hentaigana-to': {'𛁷𛁸𛁹𛁺𛁻𛁼𛁽𛁭':'to'},

	'hentaigana-na': {'𛁾𛁿𛂀𛂁𛂂𛂃𛂄𛂅𛂆':'na'},
	'hentaigana-ni': {'𛂇𛂈𛂉𛂊𛂋𛂌𛂍𛂎':'ni'},
	'hentaigana-nu': {'𛂏𛂐𛂑':'nu'},
	'hentaigana-ne': {'𛂒𛂓𛂔𛂕𛂖𛂗𛂘':'ne'},
	'hentaigana-no': {'𛂙𛂚𛂛𛂜𛂝':'no'},
	'hentaigana-ha': {'𛂞𛂟𛂠𛂡𛂢𛂣𛂤𛂥𛂦𛂧𛂨':'ha'},
	'hentaigana-hi': {'𛂩𛂪𛂫𛂬𛂭𛂮𛂯':'hi'},
	'hentaigana-hu': {'𛂰𛂱𛂲':'hu'},
	'hentaigana-he': {'𛂳𛂴𛂵𛂶𛂷𛂸𛂹':'he'},
	'hentaigana-ho': {'𛂺𛂻𛂼𛂽𛂾𛂿𛃀𛃁':'ho'},
	'hentaigana-ma': {'𛃂𛃃𛃄𛃅𛃆𛃇𛃈𛃖':'ma'},
	'hentaigana-mi': {'𛃉𛃊𛃋𛃌𛃍𛃎𛃏':'mi'},
	'hentaigana-mu': {'𛃐𛃑𛃒𛃓𛄝𛄞':'mu'},
	'hentaigana-me': {'𛃔𛃕𛃖':'me'},
	'hentaigana-mo': {'𛃗𛃘𛃙𛃚𛃛𛃜𛄝𛄞':'mo'},
	'hentaigana-ya': {'𛃝𛃞𛃟𛃠𛃡𛃢':'ya'},
	'hentaigana-yi': {'𛀆':'yi'},
	'hentaigana-yu': {'𛃣𛃤𛃥𛃦':'yu'},
	'hentaigana-ye': {'𛀁':'ye'},
	'hentaigana-yo': {'𛃧𛃨𛃩𛃪𛃫𛃬𛃢':'yo'},

	'hentaigana-ra': {'𛃭𛃮𛃯𛃰𛁽':'ra'},
	'hentaigana-ri': {'𛃱𛃲𛃳𛃴𛃵𛃶𛃷':'ri'},
	'hentaigana-ru': {'𛃸𛃹𛃺𛃻𛃼𛃽':'ru'},
	'hentaigana-re': {'𛃾𛃿𛄀𛄁':'re'},
	'hentaigana-ro': {'𛄂𛄃𛄄𛄅𛄆𛄇':'ro'},
	'hentaigana-wa': {'𛄈𛄉𛄊𛄋𛄌':'wa'},
	'hentaigana-wi': {'𛄍𛄎𛄏𛄐𛄑':'wi'},
	'hentaigana-wu': {'𛄟':'wu'},
	'hentaigana-we': {'𛄒𛄓𛄔𛄕':'we'},
	'hentaigana-wo': {'𛄖𛄗𛄘𛄙𛄚𛄛𛄜𛀅':'o'},
	'hentaigana-n': {'𛄝𛄞':'n'},
}

let source_characters = {
	'あ' : '安',
	'𛀂' : '安',
	'𛀅' : '惡',
	'𛀃' : '愛',
	'𛀄' : '阿',
	'か' : '加',
	'𛀗' : '佳',
	'𛀘' : '加',
	'𛀙' : '可',
	'𛀚' : '可',
	'𛀛' : '嘉',
	'𛀢' : '家',
	'𛀜' : '我',
	'𛀝' : '歟',
	'𛀞' : '賀',
	'𛀟' : '閑',
	'𛀠' : '香',
	'𛀡' : '駕',
	'さ' : '左',
	'𛀼' : '乍',
	'𛀽' : '佐',
	'𛀾' : '佐',
	'𛀿' : '左',
	'𛁀' : '差',
	'𛁁' : '散',
	'𛁂' : '斜',
	'𛁃' : '沙',
	'た' : '太',
	'𛁞' : '堂',
	'𛁟' : '多',
	'𛁠' : '多',
	'𛁡' : '當',
	'な' : '奈',
	'𛁾' : '南',
	'𛁿' : '名',
	'𛂀' : '奈',
	'𛂁' : '奈',
	'𛂂' : '奈',
	'𛂃' : '菜',
	'𛂄' : '那',
	'𛂅' : '那',
	'𛂆' : '難',
	'は' : '波',
	'𛂞' : '八',
	'𛂟' : '半',
	'𛂠' : '婆',
	'𛂡' : '波',
	'𛂢' : '盤',
	'𛂣' : '盤',
	'𛂤' : '破',
	'𛂥' : '者',
	'𛂦' : '者',
	'𛂧' : '葉',
	'𛂨' : '頗',
	'ま' : '末',
	'𛃂' : '万',
	'𛃃' : '末',
	'𛃄' : '末',
	'𛃅' : '滿',
	'𛃆' : '滿',
	'𛃇' : '萬',
	'𛃈' : '麻',
	'𛃖' : '馬',
	'や' : '也',
	'𛃝' : '也',
	'𛃞' : '也',
	'𛃟' : '屋',
	'𛃠' : '耶',
	'𛃡' : '耶',
	'𛃢' : '夜',
	'ら' : '良',
	'𛃭' : '羅',
	'𛃮' : '良',
	'𛃯' : '良',
	'𛃰' : '良',
	'𛁽' : '等',
	'わ' : '和',
	'𛄈' : '倭',
	'𛄉' : '和',
	'𛄊' : '和',
	'𛄋' : '王',
	'𛄌' : '王',
	'ん' : '无',
	'𛄝' : '无',
	'𛄞' : '无',
	'い' : '以',
	'𛀆' : '以',
	'𛀇' : '伊',
	'𛀈' : '意',
	'𛀉' : '移',
	'き' : '幾',
	'𛀣' : '喜',
	'𛀤' : '幾',
	'𛀥' : '幾',
	'𛀦' : '支',
	'𛀻' : '期',
	'𛀧' : '木',
	'𛀨' : '祈',
	'𛀩' : '貴',
	'𛀪' : '起',
	'し' : '之',
	'𛁄' : '之',
	'𛁅' : '之',
	'𛁆' : '事',
	'𛁇' : '四',
	'𛁈' : '志',
	'𛁉' : '新',
	'ち' : '知',
	'𛁢' : '千',
	'𛁣' : '地',
	'𛁤' : '智',
	'𛁥' : '知',
	'𛁦' : '知',
	'𛁧' : '致',
	'𛁨' : '遲',
	'に' : '仁',
	'𛂇' : '丹',
	'𛂈' : '二',
	'𛂉' : '仁',
	'𛂊' : '兒',
	'𛂋' : '爾',
	'𛂌' : '爾',
	'𛂍' : '耳',
	'𛂎' : '而',
	'ひ' : '比',
	'𛂩' : '悲',
	'𛂪' : '日',
	'𛂫' : '比',
	'𛂬' : '避',
	'𛂭' : '非',
	'𛂮' : '飛',
	'𛂯' : '飛',
	'み' : '美',
	'𛃉' : '三',
	'𛃊' : '微',
	'𛃋' : '美',
	'𛃌' : '美',
	'𛃍' : '美',
	'𛃎' : '見',
	'𛃏' : '身',
	'𛀆' : '以',
	'𛀆' : '以',
	'り' : '利',
	'𛃱' : '利',
	'𛃲' : '利',
	'𛃳' : '李',
	'𛃴' : '梨',
	'𛃵' : '理',
	'𛃶' : '里',
	'𛃷' : '離',
	'ゐ' : '為',
	'𛄍' : '井',
	'𛄎' : '井',
	'𛄏' : '居',
	'𛄐' : '爲',
	'𛄑' : '遺',
	'う' : '宇',
	'𛀊' : '宇',
	'𛀋' : '宇',
	'𛀌' : '憂',
	'𛀍' : '有',
	'𛀎' : '雲',
	'く' : '久',
	'𛀫' : '久',
	'𛀬' : '久',
	'𛀭' : '九',
	'𛀮' : '供',
	'𛀯' : '倶',
	'𛀰' : '具',
	'𛀱' : '求',
	'す' : '寸',
	'𛁊' : '受',
	'𛁋' : '壽',
	'𛁌' : '數',
	'𛁍' : '數',
	'𛁎' : '春',
	'𛁏' : '春',
	'𛁐' : '須',
	'𛁑' : '須',
	'つ' : '川',
	'𛁩' : '川',
	'𛁪' : '川',
	'𛁫' : '津',
	'𛁬' : '都',
	'𛁭' : '徒',
	'ぬ' : '奴',
	'𛂏' : '努',
	'𛂐' : '奴',
	'𛂑' : '怒',
	'ふ' : '不',
	'𛂰' : '不',
	'𛂱' : '婦',
	'𛂲' : '布',
	'む' : '武',
	'𛃐' : '武',
	'𛃑' : '無',
	'𛃒' : '牟',
	'𛃓' : '舞',
	'𛄝' : '无',
	'𛄞' : '无',
	'ゆ' : '由',
	'𛃣' : '游',
	'𛃤' : '由',
	'𛃥' : '由',
	'𛃦' : '遊',
	'る' : '留',
	'𛃸' : '流',
	'𛃹' : '留',
	'𛃺' : '留',
	'𛃻' : '留',
	'𛃼' : '累',
	'𛃽' : '類',
	'𛄟' : '汙',
	'え' : '衣',
	'𛀁' : '江',
	'𛀏' : '盈',
	'𛀐' : '縁',
	'𛀑' : '衣',
	'𛀒' : '衣',
	'𛀓' : '要',
	'け' : '計',
	'𛀳' : '介',
	'𛀲' : '介',
	'𛀢' : '家',
	'𛀴' : '希',
	'𛀵' : '氣',
	'𛀶' : '計',
	'𛀷' : '遣',
	'せ' : '世',
	'𛁒' : '世',
	'𛁓' : '世',
	'𛁔' : '世',
	'𛁕' : '勢',
	'𛁖' : '聲',
	'て' : '天',
	'𛁮' : '亭',
	'𛁯' : '低',
	'𛁰' : '傳',
	'𛁱' : '天',
	'𛁲' : '天',
	'𛁳' : '天',
	'𛁴' : '帝',
	'𛁵' : '弖',
	'𛁶' : '轉',
	'𛂎' : '而',
	'ね' : '祢',
	'𛂒' : '年',
	'𛂓' : '年',
	'𛂔' : '年',
	'𛂕' : '根',
	'𛂖' : '熱',
	'𛂗' : '禰',
	'𛂘' : '子',
	'へ' : '部',
	'𛂳' : '倍',
	'𛂴' : '弊',
	'𛂵' : '弊',
	'𛂶' : '遍',
	'𛂷' : '邊',
	'𛂸' : '邊',
	'𛂹' : '部',
	'め' : '女',
	'𛃔' : '免',
	'𛃕' : '面',
	'𛃖' : '馬',
	'𛀁' : '江',
	'𛀁' : '江',
	'れ' : '礼',
	'𛃾' : '禮',
	'𛃿' : '礼',
	'𛄀' : '連',
	'𛄁' : '麗',
	'ゑ' : '恵',
	'𛄒' : '惠',
	'𛄓' : '衞',
	'𛄔' : '衞',
	'𛄕' : '衞',
	'お' : '於',
	'𛀔' : '於',
	'𛀕' : '於',
	'𛀖' : '隱',
	'こ' : '己',
	'𛀸' : '古',
	'𛂘' : '子',
	'𛀹' : '故',
	'𛀻' : '期',
	'𛀺' : '許',
	'そ' : '曾',
	'𛁗' : '所',
	'𛁘' : '所',
	'𛁙' : '曾',
	'𛁚' : '曾',
	'𛁛' : '楚',
	'𛁜' : '蘇',
	'𛁝' : '處',
	'と' : '止',
	'𛁷' : '土',
	'𛁸' : '度',
	'𛁹' : '東',
	'𛁺' : '登',
	'𛁻' : '登',
	'𛁼' : '砥',
	'𛁽' : '等',
	'𛁭' : '徒',
	'の' : '乃',
	'𛂙' : '乃',
	'𛂚' : '濃',
	'𛂛' : '能',
	'𛂜' : '能',
	'𛂝' : '農',
	'ほ' : '保',
	'𛂺' : '保',
	'𛂻' : '保',
	'𛂼' : '報',
	'𛂽' : '奉',
	'𛂾' : '寶',
	'𛂿' : '本',
	'𛃀' : '本',
	'𛃁' : '豊',
	'も' : '毛',
	'𛃗' : '母',
	'𛃘' : '毛',
	'𛃙' : '毛',
	'𛃚' : '毛',
	'𛃛' : '茂',
	'𛃜' : '裳',
	'𛄝' : '无',
	'𛄞' : '无',
	'よ' : '与',
	'𛃧' : '代',
	'𛃨' : '余',
	'𛃩' : '與',
	'𛃪' : '與',
	'𛃫' : '與',
	'𛃬' : '餘',
	'𛃢' : '夜',
	'ろ' : '呂',
	'𛄂' : '呂',
	'𛄃' : '呂',
	'𛄄' : '婁',
	'𛄅' : '樓',
	'𛄆' : '路',
	'𛄇' : '露',
	'を' : '遠',
	'𛄖' : '乎',
	'𛄗' : '乎',
	'𛄘' : '尾',
	'𛄙' : '緒',
	'𛄚' : '越',
	'𛄛' : '遠',
	'𛄜' : '遠',
	'𛀅' : '惡',
}

var active = [];
var shuffled = [];

var replacements = {
	'o': ['wo'],
	'chi': ['ci'],
	'shi': ['si'],
	'tsu': ['tu'],
	'zu': ['du'],
	'ji': ['di', 'zi'],
	'fu': ['hu'],
	'ja': ['dya'],
	'jo': ['dyo'],
	'ju': ['dyu']
};

var cur_kana;
var cur_reading;

var total_answered = 0;
var total_correct = 0;

function save_settings() {
	inputs = document.getElementsByTagName('input');
	for (i = 0; i < inputs.length; i++) {
		if (inputs[i].type == 'checkbox') {
			checked = inputs[i].checked ? '1' : '0';
			localStorage.setItem('kana_' + inputs[i].id, checked);
		}
	}

	collect();
}

function load_settings() {
	inputs = document.getElementsByTagName('input');
	for (i = 0; i < inputs.length; i++) {
		if (inputs[i].type == 'checkbox') {
			var setting = localStorage.getItem('kana_' + inputs[i].id);
			if (setting === '1') {
				inputs[i].checked = true;
			} else if (setting === '0') {
				inputs[i].checked = false;
			}
		}
	}

	collect();
}

function check(set) {
	var trs = document.getElementsByClassName(set);
	for (i = 0; i < trs.length; i++) {
		var tds = trs[i].children;
		for (x = 0; x < tds.length; x++) {
			tds[x].children[0].checked = true;
		}
	}
	save_settings();
}

function uncheck(set) {
	var trs = document.getElementsByClassName(set);
	for (i = 0; i < trs.length; i++) {
		var tds = trs[i].children;
		for (x = 0; x < tds.length; x++) {
			tds[x].children[0].checked = false;
		}
	}
	save_settings();
}

function shuffle(orig_array) {
	var array = orig_array.slice(0);
	var currentIndex = array.length, temporaryValue, randomIndex;

	while (0 !== currentIndex) {

		randomIndex = Math.floor(Math.random() * currentIndex);
		currentIndex -= 1;

		temporaryValue = array[currentIndex];
		array[currentIndex] = array[randomIndex];
		array[randomIndex] = temporaryValue;
	}

	return array;
}

function collect() {
	kanacheck = document.getElementsByClassName('kanacheck');
	active = [];
	shuffled = [];
	for (i = 0; i < kanacheck.length; i++) {
		cur = kanacheck[i];
		if (cur.checked == true) {
			for (let key in kana[cur.id]) {
				let key_array = Array.from(key);
				for (let j = 0; j < key_array.length; j++) {
					active.push([key_array[j], kana[cur.id][key]]);
				}
			}
		}
	}
}

function show_kana() {
	wrong = false;
	document.getElementById('input_box').value = '';

	if (active.length == 0) {
		document.getElementById('hentaigana-a').checked = true;
		save_settings();
	}

	if (total_answered > 0) {
		document.getElementById('count').innerHTML = total_correct + '/' + total_answered;
		document.getElementById('message').innerHTML = '&nbsp;';
	}

	if (shuffled.length == 0) {
		shuffled = shuffle(active);
	}

	if (cur_kana && shuffled[0][0] == cur_kana) {
		shuffled.shift();
	}

	cur_kana = shuffled[0][0];
	cur_reading = shuffled[0][1];

	shuffled.shift();

	document.getElementById('kana').innerHTML = cur_kana;

	document.getElementById('answer').innerHTML = cur_reading + " (" + source_characters[cur_kana] + ")";
}

function check_answer() {
	answer = document.getElementById('input_box').value.toLowerCase();
	if (!answer) {
		answer = 'x';
	}

	chars = answer.split('');

	possible = [cur_reading];
	if (cur_reading in replacements) {
		possible = possible.concat(replacements[cur_reading]);
	}

	for (i = 0; i < chars.length; i++) {
		var err = true;

		for (x = 0; x < possible.length; x++) {
			if (chars[i] == possible[x].charAt(i)) {
				err = false;
			}
			if (answer == possible[x]) {
				answer = cur_reading;
			}
		}

		if (err) {
			break;
		}
	}

	if (err) {
		wrong = true;
		if (document.getElementById('wrong-answer-hint').checked) {
			document.getElementById('message').innerHTML = '<span id="wrong">' + cur_kana + ' = ' + cur_reading + '</span>';
		}
	}

	if (answer == cur_reading) {
		total_answered += 1;
		if (!wrong) {
			total_correct += 1;
		}
		show_kana();
	}
}

function force_next() {
	if (shuffled.length > 3) {
		shuffled.splice(3, 0, [cur_kana, cur_reading]);
	}
	if (shuffled.length > 13) {
		shuffled.splice(13, 0, [cur_kana, cur_reading]);
	}
	total_answered += 1;

	show_kana();
}

function show_answer() {
	document.getElementById('answer').style.visibility = 'visible';
}

function hide_answer() {
	document.getElementById('answer').style.visibility = 'hidden';
}

function stroke_order() {
	document.getElementById('kana').innerHTML = '<img src="stroke/' + cur_kana + '.gif" id="stroke" />';
	document.getElementById('input_box').focus();
}


onload = function () {
	load_settings();

	inputs = document.getElementsByTagName('input');
	for (i = 0; i < inputs.length; i++) {
		if (inputs[i].type == 'checkbox') {
			inputs[i].onclick = save_settings;
			inputs[i].onpropertychange = inputs[i].oninput;
		}
	}

	show_kana();

	var kana_div = document.getElementById('kana');
	kana_div.onmouseover = show_answer;
	kana_div.onmouseout = hide_answer;

	var answer_input = document.getElementById('input_box');
	answer_input.focus();
	answer_input.oninput = check_answer;
	answer_input.onpropertychange = answer_input.oninput;

	document.body.onkeydown = function (e) {
		let focus_keys = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
		let submit_keys = [" ", "Enter"];
		if ((focus_keys.includes(e.key) || submit_keys.includes(e.key)) && !(e.ctrlKey || e.altKey || e.metaKey)) {
			document.getElementById('input_box').focus();
		}

		if (submit_keys.includes(e.key)) {
			e.preventDefault();
			if (!wrong) {
				check_answer();
			} else {
				force_next();
			}
		}
	}
}